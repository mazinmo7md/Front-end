{% extends "base.html" %} {% load static %} {% block content %}
<div
  id="offersCarousel"
  class="carousel slide mb-5"
  data-bs-ride="carousel"
>
  <!-- العدادات -->
  <div class="carousel-indicators">
    {% for offer in offers %}
    <button
      type="button"
      data-bs-target="#offersCarousel"
      data-bs-slide-to="{{ forloop.counter0 }}"
      class="{% if forloop.first %}active{% endif %}"
      aria-current="true"
      aria-label="Slide {{ forloop.counter }}"
    ></button>
    {% endfor %}
  </div>

  <!-- الصور -->
  <div class="carousel-inner">
    {% if offers %} {% for offer in offers %}
    <div class="carousel-item {% if forloop.first %}active{% endif %}">
      {% if offer.link_category %}
      <a href="{% url 'shop:category' offer.link_category.slug %}">
        <img src="{{ offer.image.url }}" alt="{{ offer.alt }}" />
      </a>
      {% else %}
      <img src="{{ offer.image.url }}" alt="{{ offer.alt }}" />
      {% endif %}
    </div>
    {% endfor %} {% else %}
    <p>لا توجد عروض.</p>
    {% endif %}
  </div>

  <!-- الأسهم -->
  <button
    class="carousel-control-prev"
    type="button"
    data-bs-target="#offersCarousel"
    data-bs-slide="prev"
  >
    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
    <span class="visually-hidden">السابق</span>
  </button>
  <button
    class="carousel-control-next"
    type="button"
    data-bs-target="#offersCarousel"
    data-bs-slide="next"
  >
    <span class="carousel-control-next-icon" aria-hidden="true"></span>
    <span class="visually-hidden">التالي</span>
  </button>
</div>

<div class="categ">
  <!-- شريط الأقسام الأفقي -->
  <div class="categories">
    <a
      href="{% url 'shop:index' %}"
      class="chip {% if active_all %}active{% endif %}"
      >الكل</a
    >
    {% if categories %} {% for c in categories %}
    <a
      href="{% url 'shop:category' c.slug %}"
      class="chip {% if selected_category and selected_category.id == c.id %}active{% endif %}"
      style="position: relative"
    >
      <!-- صورة القسم -->
      {% if c.image %}
      <div class="category-icon">
        <img src="{{ c.image.url }}" alt="{{ c.name }}" />
      </div>
      {% endif %}

      <!-- اسم القسم -->
      {{ c.name }}

      <!-- الليبل + الانيميشن القديم -->
      {% if c.show_label and c.label_text %}
      <span
        class="category-label"
        style="background-color: {{ c.label_color }}; margin-right:8px; padding:2px 6px; border-radius:6px; color:#fff; font-size:12px;"
      >
        {{ c.label_text }}
      </span>
      <lottie-player
        class="lottie"
        src="{% static 'animations/Fire.json' %}"
        background="transparent"
        speed="1"
        style="
          width: 24px;
          height: 24px;
          display: inline-block;
          vertical-align: middle;
        "
        loop
        autoplay
      >
      </lottie-player>
      {% endif %}
    </a>
    {% endfor %} {% else %}
    <span>لا توجد أقسام.</span>
    {% endif %}
  </div>
</div>

<!-- شبكة المنتجات -->
<div class="content" id="products">
  <div class="category-name">
    {% if selected_category %}
    <h2>{{ selected_category.name }}</h2>
    {% else %}
    <h2>كل المنتجات</h2>
    {% endif %}
  </div>
  <div class="grid">
    {% if products %} {% for p in products %}
    <a href="{% url 'shop:product_detail' p.id %}" class="card-link">
      <div class="card">
        <div class="thumb">
          {% if p.images.all %}
          <img src="{{ p.images.first.image.url }}" alt="{{ p.name }}" />
          {% else %}
          <div class="placeholder">لا توجد صورة</div>
          {% endif %}

          <!-- زرار الـ wishlist -->
          <a
            href="#"
            class="wishlist-btn"
            data-id="{{ p.id }}"
            style="
              position: absolute;
              right: 5px;
              top: 5px;
              text-decoration: none;
              font-size: 25px;
              color: rgb(253 13 13);
              border-radius: 50% !important;
              padding: 5px !important;
              transition: all 0.3s ease !important;
            "
          >
            {% if p.id in user_wishlist %}
            <i class="fas fa-heart text-red-500"></i>
            {% else %}
            <i class="far fa-heart text-gray-400"></i>
            {% endif %}
          </a>

          <!--  الشعلة تظهر لو في خصم -->
          {% if p.discounted_price %}
          <lottie-player
            src="{% static 'animations/Fire.json' %}"
            background="transparent"
            speed="1"
            style="
              width: 40px;
              height: 40px;
              position: absolute;
              left: 5px;
              top: 5px;
              z-index: 2;
            "
            loop
            autoplay
          >
          </lottie-player>
          {% endif %}

          <!-- السعر -->
          <div class="price">
            {% if p.discounted_price %}
            <span class="old-price">{{ p.price }}</span>
            <span class="new-price">EGP {{ p.discounted_price }}</span>
            {% else %}
            <span class="normal-price">EGP {{ p.price }}</span>
            {% endif %}
          </div>
        </div>

        <div class="info">
          <h3 class="name">{{ p.name }}</h3>
        </div>
      </div>
    </a>
    {% endfor %} {% else %}
    <p>لا توجد منتجات.</p>
    {% endif %}
  </div>
</div>

<!-- بانرات -->
<div
  id="bannersCarousel"
  class="carousel slide my-5"
  data-bs-ride="carousel"
>
  <div class="carousel-inner">
    {% if banners %} {% for banner in banners %}
    <div class="carousel-item {% if forloop.first %}active{% endif %}">
      {% if banner.link_category %}
      <a href="{% url 'shop:category' banner.link_category.slug %}">
        <img
          src="{{ banner.image.url }}"
          class="d-block w-100"
          alt="{{ banner.alt }}"
        />
      </a>
      {% else %}
      <img
        src="{{ banner.image.url }}"
        class="d-block w-100"
        alt="{{ banner.alt }}"
      />
      {% endif %}
    </div>
    {% endfor %} {% else %}
    <p>لا توجد بانرات.</p>
    {% endif %}
  </div>

  <!-- الأسهم -->
  <button
    class="carousel-control-prev"
    type="button"
    data-bs-target="#bannersCarousel"
    data-bs-slide="prev"
  >
    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
    <span class="visually-hidden">السابق</span>
  </button>
  <button
    class="carousel-control-next"
    type="button"
    data-bs-target="#bannersCarousel"
    data-bs-slide="next"
  >
    <span class="carousel-control-next-icon" aria-hidden="true"></span>
    <span class="visually-hidden">التالي</span>
  </button>
</div>

<style>
  .container{
    padding: unset !important;
    margin: unset !important;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const hasQuery = "{{ query|default:'' }}".trim();
    if (hasQuery) {
      const productsSection = document.getElementById("products");
      if (productsSection) {
        productsSection.scrollIntoView({ behavior: "smooth" });
      }
    }
  });
</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const hasQuery = "{{ query|default:'' }}".trim();
    const hasCategory = "{{ selected_category|default:'' }}".trim();

    if (hasQuery || hasCategory) {
      const productsSection = document.getElementById("products");
      if (productsSection) {
        productsSection.scrollIntoView({ behavior: "smooth" });
      }
    }
  });
</script>

{% endblock %}
